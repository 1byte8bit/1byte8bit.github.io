<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> EHR系统员工生日提醒（跨年查询）总结与笔记 · 秀儿,是你吗?</title><meta name="description" content="EHR系统员工生日提醒（跨年查询）总结与笔记 - qiu_"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://youxiu.net/atom.xml" title="秀儿,是你吗?"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">EHR系统员工生日提醒（跨年查询）总结与笔记</h1><div class="post-info">Dec 19, 2018</div><div class="post-content"><a id="more"></a>
<h3 id="1、概要"><a href="#1、概要" class="headerlink" title="1、概要"></a>1、概要</h3><p>生日跨年提醒，在EHR系统中，用户选择某个时间段都那些人过生日，并发送邮件提醒；本文只描述如何去跨年查询。<br>前端使用Vue.js/Element UI;<br>后端使用Java/Spring Cloud/微服务架构模式<br>本文修改于：2019年03月15日</p>
<h3 id="2、思路"><a href="#2、思路" class="headerlink" title="2、思路"></a>2、思路</h3><p>1、前端获取的是时间段，用户输入的时间段发送给后端的时候，判断一下用户选择的时间；<br>2、如果没有跨年，则调用函数a；<br>3、如果跨年了，则调用函数b；</p>
<h3 id="3、实现过程"><a href="#3、实现过程" class="headerlink" title="3、实现过程"></a>3、实现过程</h3><h4 id="3-1、前端实现"><a href="#3-1、前端实现" class="headerlink" title="3.1、前端实现"></a>3.1、前端实现</h4><h6 id="3-1-1、界面效果"><a href="#3-1-1、界面效果" class="headerlink" title="3.1.1、界面效果"></a>3.1.1、界面效果</h6><p><img src="../../../../../../images/2.png" alt=""></p>
<p>Element UI时间组件：<a href="http://element-cn.eleme.io/#/zh-CN/component/date-picker" target="_blank" rel="noopener">点击这里</a></p>
<h6 id="3-1-2、前端代码"><a href="#3-1-2、前端代码" class="headerlink" title="3.1.2、前端代码"></a>3.1.2、前端代码</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">handleFilter() &#123;</span><br><span class="line">  <span class="keyword">this</span>.searchkpi();</span><br><span class="line">  <span class="keyword">this</span>.listQuery.startDataBirthdayPoint = <span class="keyword">this</span>.employeeBirthday[<span class="number">0</span>].toString().substring(<span class="number">5</span>, <span class="number">10</span>).replace(<span class="string">'-'</span>, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">this</span>.listQuery.endDataBirthdayPoint = <span class="keyword">this</span>.employeeBirthday[<span class="number">1</span>].toString().substring(<span class="number">5</span>, <span class="number">10</span>).replace(<span class="string">'-'</span>, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.employeeBirthday[<span class="number">0</span>].toString().substring(<span class="number">0</span>, <span class="number">4</span>) === <span class="keyword">this</span>.employeeBirthday[<span class="number">1</span>].toString().substring(<span class="number">0</span>, <span class="number">4</span>)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.getListNotAcrossYear();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.getList();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 代码片段1</span></span><br></pre></td></tr></table></figure>
<p>第5行代码，判断了年份是否相同，如果年份是否相同，如果相同，则调用<b>this.getListNotAcrossYear</b>, 调用接口：<b>pageBirthdayNotAcrossYear()</b>, 参数为this.listQuery;<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">getListNotAcrossYear() &#123;</span><br><span class="line">  <span class="keyword">this</span>.loading = <span class="literal">true</span>;</span><br><span class="line">  pageBirthdayNotAcrossYear(<span class="keyword">this</span>.listQuery)</span><br><span class="line">    .then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.list = response.data.rows;</span><br><span class="line">      <span class="keyword">this</span>.total = response.data.total;</span><br><span class="line">      <span class="keyword">this</span>.loading = <span class="literal">false</span>;</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(error)</span><br><span class="line">      <span class="keyword">this</span>.loading = <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">// 代码片段2</span></span><br></pre></td></tr></table></figure></p>
<p><b>this.listQuery</b>包含两个字段：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">startDataBirthdayPoint: <span class="literal">undefined</span>,</span><br><span class="line">endDataBirthdayPoint: <span class="literal">undefined</span></span><br><span class="line"> <span class="comment">// 代码片段3</span></span><br></pre></td></tr></table></figure></p>
<p>这两个字段，作为listQuery的一部分，作为参数，通过前端的API请求接口，传递给后端:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生日提醒</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">pageBirthdayNotAcrossYear</span>(<span class="params">query</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> request(&#123;</span><br><span class="line">    url: <span class="string">'/api/admin/mEmployeeInfo/pageBirthdayNotAcrossYear'</span>,</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    params: query</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">// 代码片段4</span></span><br></pre></td></tr></table></figure></p>
<p>从接口中可以看到：传入的参数是<b>query</b>,使用GET的方式传递给后端。<br>相同的，在<b>代码片段1</b>中的第8行，则是请求跨年的，在前端的代码部分都是一样的，这里我是在前端就对其进行了分开，后来想了想，如果日期传递到后端，在后端进行处理，代码量要少很多。</p>
<h4 id="3-2、后端实现"><a href="#3-2、后端实现" class="headerlink" title="3.2、后端实现"></a>3.2、后端实现</h4><p>先看下不跨年的，包含Java代码和MyBatis的.xml映射文件；</p>
<h6 id="3-2-1、Java代码"><a href="#3-2-1、Java代码" class="headerlink" title="3.2.1、Java代码"></a>3.2.1、Java代码</h6><p>首先是Controller类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"mEmployeeInfo"</span>)</span><br><span class="line"><span class="comment">// 代码片段5</span></span><br></pre></td></tr></table></figure></p>
<p>应和了在代码片段4中的请求接口；<br>这是Java代码Controller的函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/pageBirthdayNotAcrossYear"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TableResultResponse&lt;MEmployeeInfo&gt; <span class="title">selectBirthdayNotAcrossYear</span><span class="params">(@RequestParam Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">    PageQuery query = <span class="keyword">new</span> PageQuery(params, params);</span><br><span class="line">    <span class="keyword">return</span> mEmployeeInfoBiz.selectBirthdayNotAcrossYear(query);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//代码片段6</span></span><br></pre></td></tr></table></figure></p>
<p>函数的类型是<b>TableResultResponse</b>,返回的是一个结果集；</p>
<p>这是Java代码Service类的函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生日到期提醒(不跨年)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TableResultResponse&lt;MEmployeeInfo&gt; <span class="title">selectBirthdayNotAcrossYear</span><span class="params">(PageQuery&lt;MEmployeeInfo&gt; query)</span> </span>&#123;</span><br><span class="line">    PageExample example = <span class="keyword">new</span> PageExample(MEmployeeInfo.class, query.getData());</span><br><span class="line">    Page&lt;MEmployeeInfo&gt; result = PageHelper.startPage(query.getPage(), query.getLimit());</span><br><span class="line">    List&lt;MEmployeeInfo&gt; list = mEmployeeInfoMapper.selectBirthdayNotAcrossYear(example);</span><br><span class="line">    <span class="keyword">if</span> (list.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mergeCore.mergeResult(MEmployeeInfo.class, list);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> TableResultResponse&lt;MEmployeeInfo&gt;(result.getTotal(), list);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 代码片段7</span></span><br></pre></td></tr></table></figure></p>
<p>DAO类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;MEmployeeInfo&gt; <span class="title">selectBirthdayNotAcrossYear</span><span class="params">(Object example)</span></span>;</span><br><span class="line"><span class="comment">// 代码片段8</span></span><br></pre></td></tr></table></figure></p>
<h4 id="3-2-2、MyBatis的映射文件"><a href="#3-2-2、MyBatis的映射文件" class="headerlink" title="3.2.2、MyBatis的映射文件"></a>3.2.2、MyBatis的映射文件</h4><p>接下来是MyBatis的映射文件代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">"selectBirthdayNotAcrossYear"</span> parameterType=<span class="string">"com.savor.security.common.entity.PageExample"</span> resultMap=<span class="string">"BaseResultMap"</span>&gt;</span><br><span class="line">    SELECT</span><br><span class="line">    t.*, y.position_name</span><br><span class="line">    FROM</span><br><span class="line">    m_employee_info t</span><br><span class="line">    LEFT JOIN m_position y ON t.position_id = y.position_id</span><br><span class="line">    WHERE</span><br><span class="line">    t.employee_id IS NOT NULL</span><br><span class="line">    &lt;<span class="keyword">if</span> test=<span class="string">"data.startDataBirthdayPoint != null and data.startDataBirthdayPoint != '' and data.endDataBirthdayPoint != null and data.endDataBirthdayPoint !=''"</span>&gt;</span><br><span class="line">        AND DATE_FORMAT(t.employee_birthday , '%m%d') BETWEEN #&#123;data.startDataBirthdayPoint&#125; AND #&#123;data.endDataBirthdayPoint&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">-- 代码片段<span class="number">9</span></span><br></pre></td></tr></table></figure></p>
<p>跨年的请求处理，跟上面的代码没有区别，不同之处体现在最后的映射文件这里：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">"selectByBirthday"</span> parameterType=<span class="string">"com.savor.security.common.entity.PageExample"</span> resultMap=<span class="string">"BaseResultMap"</span>&gt;</span><br><span class="line">    select a.* from (</span><br><span class="line">    SELECT</span><br><span class="line">    t.*, y.position_name</span><br><span class="line">    FROM</span><br><span class="line">    m_employee_info t</span><br><span class="line">    LEFT JOIN m_position y ON t.position_id = y.position_id</span><br><span class="line">    WHERE</span><br><span class="line">    t.employee_id IS NOT NULL</span><br><span class="line">    &lt;<span class="keyword">if</span> test=<span class="string">"data.startDataBirthdayPoint != null and data.startDataBirthdayPoint != '' and data.endDataBirthdayPoint != null and data.endDataBirthdayPoint !=''"</span>&gt;</span><br><span class="line">        AND DATE_FORMAT(t.employee_birthday , '%m%d') BETWEEN #&#123;data.startDataBirthdayPoint&#125; AND #&#123;data.endDataBirthdayPoint&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">    UNION ALL</span><br><span class="line">    SELECT</span><br><span class="line">    t.*, y.position_name</span><br><span class="line">    FROM</span><br><span class="line">    m_employee_info t</span><br><span class="line">    LEFT JOIN m_position y ON t.position_id = y.position_id</span><br><span class="line">    WHERE</span><br><span class="line">    t.employee_id IS NOT NULL</span><br><span class="line">    &lt;<span class="keyword">if</span> test=<span class="string">"data.startDataBirthdayPoint != null and data.startDataBirthdayPoint != '' and data.endDataBirthdayPoint != null and data.endDataBirthdayPoint !=''"</span>&gt;</span><br><span class="line">        <span class="function">AND <span class="title">DATE_FORMAT</span><span class="params">(t.employee_birthday , <span class="string">'%m%d'</span>)</span> BETWEEN #</span>&#123;data.startDataBirthdayPoint&#125; AND <span class="string">'1231'</span></span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">    UNION ALL</span><br><span class="line">    SELECT</span><br><span class="line">    t.*, y.position_name</span><br><span class="line">    FROM</span><br><span class="line">    m_employee_info t</span><br><span class="line">    LEFT JOIN m_position y ON t.position_id = y.position_id</span><br><span class="line">    WHERE</span><br><span class="line">    t.employee_id IS NOT NULL</span><br><span class="line">    &lt;<span class="keyword">if</span> test=<span class="string">"data.startDataBirthdayPoint != null and data.startDataBirthdayPoint != '' and data.endDataBirthdayPoint != null and data.endDataBirthdayPoint !=''"</span>&gt;</span><br><span class="line">        <span class="function">AND <span class="title">DATE_FORMAT</span><span class="params">(t.employee_birthday , <span class="string">'%m%d'</span>)</span> BETWEEN '0101' AND #</span>&#123;data.endDataBirthdayPoint&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">    ) as a</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>其中也分成了三段，第一段就是正常的输入日期，但是不会去调用了。<br>后两段是：<br>如果跨年的时候，比如选择这个时间段2018-12-05~2019-03-15进行查询，那么数据流到映射文件这里的时候，会被分成两段（因为生日是考虑月日的，不考虑年）：就是12-05~12-31一部分人；01-01~03-15第二部分人；最后加起来，就是要的人数；</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/03/07/16d9fb52-dd5b-4339-9b38-a98df48a8b46/" class="prev">PREV</a></div><div class="copyright"><p>© 2014 - 2020 <a href="https://youxiu.net">qiu_</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>